<project name="NGO.km Ant Deployment Utility" default="ngo.echo" basedir=".">

	<property file="build.properties" />

	<path id="catalina-ant-classpath">
		<fileset dir="${tomcat.home}/lib">
			<include name="catalina-ant.jar" />
			<include name="tomcat-coyote.jar" />
			<include name="tomcat-util.jar" />
		</fileset>
		<fileset dir="${tomcat.home}/bin">
			<include name="tomcat-juli.jar" />
		</fileset>
	</path>
	<taskdef file="${project.root}/util/ant/tomcatTasks.properties">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>


	<path id="ngo-ant-classpath">
		<fileset dir="${project.root}/util/ant/lib">
			<include name="ngotask.jar" />
			<include name="commons-net-1.4.1.jar" />
			<include name="jakarta-oro-2.0.8.jar" />
		</fileset>
		<fileset dir="${project.root}/util/jsc">
			<include name="yuicompressor-2.4.8.jar" />
			<include name="commons-io-2.5.jar" />
		</fileset>
		<fileset dir="${project.root}/util/gzip">
			<include name="commons-compress-1.14.jar" />
		</fileset>
		<fileset dir="${project.root}/util/md5">
			<include name="commons-codec-1.10.jar" />
		</fileset>
	</path>
	
	<taskdef file="${project.root}/util/ant/ngoTasks.properties">
		<classpath refid="ngo-ant-classpath" />
	</taskdef>

	<!--default-->
	<target name="ngo.echo">
		<echo message="${project.name} ${project.ver},  basedir=${basedir}, project.root=${project.root}" />
	</target>


	<!-- basic targets -->
	<target name="project.clean">
		<delete dir="${dest.dir}" />
	</target>
	
	<target name="project.war2" description="build war" depends="project.clean">
			<mkdir dir="${dist.dir}" />
			<war destfile="${dist.dir}/ROOT.war">
				<fileset dir="${project.root}">
					<exclude name="WEB-INF/src/**"/>
					<exclude name="WEB-INF/sql/**"/>
					<exclude name="**/*.js" />
					<exclude name="ref/**" />
					<exclude name="util/**" />
				</fileset>
			</war>
		</target>

	<!-- NGO resource package -->
	<target name="KM.js.compress" description="Javascript compression">
		<compress ignore="\app\lib\dat.gui.js|\app\lib\three.js" include=".*\.js" exclude=".*\.min\.js" fileExtension="min.js" path="${project.root}" />
	</target>

	<target name="KM.css.gzip" description="Gzip for css">
		<ngzip include=".*\.css" exclude="__NOMATCH__" fileExtension="ngcss" path="${project.root}" />
	</target>
				
	<target name="KM.js.gzip" description="javascript compress, then gzip" depends="KM.js.compress">
		<ngzip include=".*\.min\.js" exclude="__NOMATCH__" fileExtension="ngjs" path="${project.root}" />
	</target>

	<!--This task is only for DEV debug purpose only-->
	<target name="DEV.js.gzip" description="Javascript gzip without compress">
		<ngzip include=".*\.js" exclude=".*\.min\.js" fileExtension="min.ngjs" path="${project.root}" />
	</target>
	
	<target name="DEV.png.base64" description="convert PNG file to base64 file">
			<ngbase64 include=".*\.png" exclude="__NOMATCH__" fileExtension="b64" path="${project.root}" />
	</target>
	
	<target name="DEV.png.gzip" description="base64 png file gzip" depends="DEV.png.base64">
			<ngzip include=".*\.b64" exclude="__NOMATCH__" fileExtension="ngpng" path="${project.root}" />
		</target>

	<!--new NG resouce needs to be registered in include-->
	<target name="KM.bom" description="" depends="KM.js.gzip">
		<ngbom validate="true" include=".*\.ng(js|css|png)" exclude="__NOMATCH__" 
			bomRoot="/bom/" 
			appRoot="/app/"
			metaName="/meta.txt"
			cdnName="/7cdn.txt"
			modName="/7mod.txt"
			bomOutFile="/out/boms.txt" 
			moduleOutput="/out/modules.txt" 
			gradeOutput="/out/grades.txt" 
			path="${project.root}"  
			spliter="|"/>
	</target>

	<target name="DEV.bom" description="" depends="DEV.js.gzip">
		<ngbom validate="true" include=".*\.ng(js|css|png)" exclude="__NOMATCH__" 
			bomRoot="/bom/" 
			appRoot="/app/" 
			metaName="/meta.txt"
			cdnName="/7cdn.txt"
			modName="/7mod.txt"
			bomOutFile="/out/boms.txt" 
			moduleOutput="/out/modules.txt" 
			gradeOutput="/out/grades.txt" 
			path="${project.root}"  spliter="|"/>
	</target>

	<!-- NGO web manager interface - caching -->
	<target name="DEV.push" description="" depends="DEV.bom">
		<get src="${dev.push.url}" dest="${project.root}/out/push.log" username="${dev.base.user}" password="${dev.base.pass}"/>
		<loadfile property="push.output" srcFile="${project.root}/out/push.log"/>
		<echo message="${push.output}" />
	</target>
	
	<target name="DEV.push.DEBUG" description="" depends="DEV.bom">
		<get src="${dev.debug.push.url}" dest="${project.root}/out/push.DEBUG.log" username="${dev.base.user}" password="${dev.base.pass}"/>
			<loadfile property="push.output" srcFile="${project.root}/out/push.DEBUG.log"/>
			<echo message="${push.output}" />
	</target>
	
	
	<target name="DEV.TANCY.push" description="" depends="DEV.bom">
		<copy todir="${dev.tancy.bom.out}" verbose="yes">
		    <fileset dir="${project.root}/out/">
		      <exclude name="**/*.log"/>
		    </fileset>
		  </copy>
		<get src="${dev.tancy.push.url}" dest="${project.root}/out/tancy.push.log" username="${dev.base.user}" password="${dev.base.pass}"/>
		<loadfile property="tancy.push.output" srcFile="${project.root}/out/tancy.push.log"/>
		<echo message="Tancy push done: ${tancy.push.output}" />
	</target>
	
	<target name="DEV.cache.refresh" description="" depends="DEV.push">
		<get src="${dev.cache.url}" dest="${project.root}/out/cache.log" username="${dev.base.user}" password="${dev.base.pass}"/>
		<loadfile property="cache.output" srcFile="${project.root}/out/cache.log"/>
		<echo message="${cache.output}" />
	</target>
	
	<target name="DEV.jmx.webResource.clear" description="" depends="DEV.cache.refresh">
		<get src="${dev.jmx.wrr.clear}" dest="${project.root}/out/dev.jmx.wrr.clear.log" username="${dev.jmx.user}" password="${dev.jmx.pass}"/>
		<loadfile property="jmx.clear.output" srcFile="${project.root}/out/dev.jmx.wrr.clear.log"/>
		<echo message="Dev JMX WebResourceRoot clear invoked : ${jmx.clear.output}" />
	</target>
	
	
	<!-- NGO web manager interface - caching -->
	<target name="KM.TANCY.push" description="" depends="KM.ftp.app,KM.TANCY.ftp.out">
		<get src="${km.tancy.push.url}" dest="${project.root}/out/km.tancy.push.log" username="${km.base.user}" password="${km.base.pass}"/>
		<loadfile property="push.output" srcFile="${project.root}/out/km.tancy.push.log"/>
		<echo message="KisMath tancy push: ${push.output}" />
	</target>
	
	<target name="KM.cache.refresh" description="" depends="KM.TANCY.push">
			<get src="${km.cache.url}" dest="${project.root}/out/km.cache.log" username="${km.base.user}" password="${km.base.pass}"/>
			<loadfile property="km.cache.output" srcFile="${project.root}/out/km.cache.log"/>
			<echo message="KidsMath ${km.cache.output}" />
	</target>
	
	<target name="KM.jmx.webResource.clear" description="" depends="KM.cache.refresh">
			<get src="${km.jmx.wrr.clear}" dest="${project.root}/out/km.jmx.wrr.clear.log" username="${km.jmx.user}" password="${km.jmx.pass}"/>
			<loadfile property="km.jmx.clear.output" srcFile="${project.root}/out/km.jmx.wrr.clear.log"/>
			<echo message="KidsMath WebResourceRoot clear via JMX: ${km.jmx.clear.output}" />
		</target>
	
	<!-- TODO: check the accessibility of  cdn files in cdn.txt -->
	<target name="validate.cdn">
		
	</target>
	
	<target name="KM.TANCY.ftp.out" description="upload out files to tancy" depends="">
			<ftp server="${km.ftp.ip}"
			       remotedir="${km.tancy.ftp.dir}"
			       userid="${km.ftp.user}"
			       password="${km.ftp.pass}"
				   passive="yes"
				   depends="no"
				   binary="no"
			       verbose="yes">
				<fileset dir="${project.root}">
					<exclude name="app/**" />
					<exclude name="bom/**" />
					<exclude name="ref/**" />
					<exclude name="util/**" />
					<exclude name="out/*.log"/>
					<exclude name="WEB-INF/**" />
					<exclude name="META-INF/**" />
				</fileset>
			</ftp>
		</target>
	
	
	<target name="KM.ftp.app" description="upload client pack to web server" depends="KM.bom">
		<ftp server="${km.ftp.ip}"
		       remotedir="${km.ftp.dir}"
		       userid="${km.ftp.user}"
		       password="${km.ftp.pass}"
			   passive="yes"
			   depends="no"
			   binary="yes"
		       verbose="yes">
			<fileset dir="${project.root}">
				<include name="**/*.htm" />
				<include name="**/*.ngjs" />
				<include name="**/*.ngpng" />
				<include name="**/*.ngcss" />
				<exclude name="ref/**" />
				<exclude name="util/**" />
				<exclude name="out/*.log"/>
				<exclude name="WEB-INF/**" />
				<exclude name="META-INF/**" />
			</fileset>
		</ftp>
	</target>
	
	<target name="KM.ftp.java" description="upload client pack to web server" depends="">
		<ftp server="${km.ftp.ip}"
			   remotedir="${km.ftp.dir}"
			   userid="${km.ftp.user}"
			   password="${km.ftp.pass}"
			   passive="yes"
			   depends="no"
			   binary="yes"
		       verbose="yes">
			<fileset dir="${project.root}">
				<exclude name="WEB-INF/src/**"/>
				<exclude name="WEB-INF/sql/**"/>
				<exclude name="app/**" />
				<exclude name="bom/**" />
				<exclude name="ref/**" />
				<exclude name="out/**" />
				<exclude name="util/**" />
			</fileset>
		</ftp>
	</target>

	<!-- Tomcat manager interface -->
	<target name="tomcat.deploy" description="Install web application" depends="">
		<deploy url="${url}" username="${username}" password="${password}" path="${path}" war="${dist.dir}/ROOT.war" />
	</target>

	<target name="tomcat.reload" description="Reload web application" depends="">
		<reload url="${url}" username="${username}" password="${password}" path="${path}" />
	</target>

	<target name="tomcat.undeploy" description="Remove web application">
		<undeploy url="${url}" username="${username}" password="${password}" path="${path}" />
	</target>


</project>