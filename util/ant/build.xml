<project name="NGO.km Ant Deployment Utility" default="ngo.echo" basedir=".">

	<property file="build.properties" />

	<path id="catalina-ant-classpath">
		<fileset dir="${tomcat.home}/lib">
			<include name="catalina-ant.jar" />
			<include name="tomcat-coyote.jar" />
			<include name="tomcat-util.jar" />
		</fileset>
		<fileset dir="${tomcat.home}/bin">
			<include name="tomcat-juli.jar" />
		</fileset>
	</path>
	<taskdef file="${project.root}/util/ant/tomcatTasks.properties">
		<classpath refid="catalina-ant-classpath" />
	</taskdef>


	<path id="ngo-ant-classpath">
		<fileset dir="${project.root}/util/ant/lib">
			<include name="ngotask.jar" />
			<include name="commons-net-1.4.1.jar" />
			<include name="jakarta-oro-2.0.8.jar" />
		</fileset>
		<fileset dir="${project.root}/util/jsc">
			<include name="yuicompressor-2.4.8.jar" />
			<include name="commons-io-2.5.jar" />
		</fileset>
		<fileset dir="${project.root}/util/gzip">
			<include name="commons-compress-1.14.jar" />
		</fileset>
		<fileset dir="${project.root}/util/md5">
			<include name="commons-codec-1.10.jar" />
		</fileset>
	</path>
	
	<taskdef file="${project.root}/util/ant/ngoTasks.properties">
		<classpath refid="ngo-ant-classpath" />
	</taskdef>

	<!--default-->
	<target name="ngo.echo">
		<echo message="${project.name} ${project.ver},  basedir=${basedir}, project.root=${project.root}" />
	</target>


	<!-- basic targets -->
	<target name="project.clean">
		<delete dir="${dest.dir}" />
	</target>


	<target name="project.war" description="build war" depends="project.clean">
		<mkdir dir="${dist.dir}" />
		<war destfile="${dist.dir}/ROOT.war" webxml="${project.root}/WEB-INF/web.xml">
			<classes dir="${project.root}/WEB-INF/classes" />
			<fileset dir="${project.root}">
				<exclude name="WEB-INF/web.xml" />
				<exclude name="WEB-INF/classes/**" />
				<exclude name="WEB-INF/lib/**" />
				<exclude name="WEB-INF/src/**" />
				<exclude name="**/*.js" />
				<exclude name="doc/**" />
				<exclude name="util/**" />
			</fileset>
			<lib dir="${project.root}/WEB-INF/lib" />
		</war>
	</target>

	<!-- NGO resource package -->
	<target name="js.confusion" description="Javascript Confusion">
		<confusion ignore="\app\lib\dat.gui.js|\app\lib\three.js" include=".*\.js" exclude=".*\.min\.js" fileExtension="min.js" path="${project.root}" />
	</target>

	<target name="js.gzip" description="Confusion and Gzip for javascript " depends="js.confusion">
		<ngzip include=".*\.min\.js" exclude="__NOMATCH__" fileExtension="ngjs" path="${project.root}" />
	</target>
	
	<target name="css.gzip" description="Gzip for css">
			<ngzip include=".*\.css" exclude="__NOMATCH__" fileExtension="ngcss" path="${project.root}" />
		</target>

	<!--This task is only for DEV debug purpose only-->
	<target name="js.gzip.DEV" description="Javascript Gzip without confusion">
		<ngzip include=".*\.js" exclude=".*\.min\.js" fileExtension="min.ngjs" path="${project.root}" />
	</target>

	<!--new NG resouce needs to be registered in include-->
	<target name="bom" description="" depends="js.gzip">
		<ngbom validate="true" include=".*\.ng(js|css)" exclude="__NOMATCH__" bomRoot="/bom/" appRoot="/app/" outFile="/bom/boms.txt" moduleOutput="/bom/modules.txt" gradeOutput="/bom/grades.txt" path="${project.root}"  spliter="|"/>
	</target>

	<target name="bom.DEV" description="" depends="js.gzip.DEV">
		<ngbom validate="true" include=".*\.ng(js|css)" exclude="__NOMATCH__" bomRoot="/bom/" appRoot="/app/" outFile="/bom/boms.txt" moduleOutput="/bom/modules.txt" gradeOutput="/bom/grades.txt" path="${project.root}"  spliter="|"/>
	</target>
	

	<!-- NGO web manager interface - caching -->
	<target name="bom.push.DEV" description="" depends="bom.DEV">
		<get src="http://localhost/json/deploy?token=123&amp;path=/bom/boms.txt" dest="${project.root}/bom/push.log" username="ngoScript" password="1234"/>
		<loadfile property="push.output" srcFile="${project.root}/bom/push.log"/>
		<echo message="${push.output}" />
	</target>
	
	<target name="ftp.app.DEV" description="upload client pack to web server" depends="">
		<ftp server="39.106.1.237"
		       remotedir="/dev/apache-tomcat-8.0.46/webapps/ROOT"
		       userid="ngoftpd1"
		       password="Up!0ad2km$"
			   passive="no"
			   depends="no"
			   binary="no"
		       verbose="yes">
			<fileset dir="${project.root}">
				<exclude name="WEB-INF/**" />
				<exclude name="META-INF/**" />
				<exclude name="doc/**" />
				<exclude name="util/**" />
			</fileset>
		</ftp>
	</target>
	
	<target name="ftp.java.DEV" description="upload client pack to web server" depends="">
			<ftp server="39.106.1.237"
			       remotedir="/dev/apache-tomcat-8.0.46/webapps/ROOT"
			       userid="ngoftpd1"
			       password="Up!0ad2km$"
			       separator="\"
			       verbose="yes">
				<fileset dir="${project.root}">
					<exclude name="app/**" />
					<exclude name="bom/**" />
					<exclude name="doc/**" />
					<exclude name="util/**" />
				</fileset>
			</ftp>
		</target>

	<!-- Tomcat manager interface -->
	<target name="tomcat.deploy" description="Install web application" depends="">
		<deploy url="${url}" username="${username}" password="${password}" path="${path}" war="${dist.dir}/ROOT.war" />
	</target>

	<target name="tomcat.reload" description="Reload web application" depends="">
		<reload url="${url}" username="${username}" password="${password}" path="${path}" />
	</target>

	<target name="tomcat.undeploy" description="Remove web application">
		<undeploy url="${url}" username="${username}" password="${password}" path="${path}" />
	</target>


</project>