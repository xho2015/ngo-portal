var TAFFY,exports,T;(function(){var g,r,q,u,e,b,o,n,s,f,c,v,x,w,i,h,k,p,j,m,a,t,l,d;if(!TAFFY){e="2.7";b=1;o="000000";n=1000;s={};d=function(z){var y=Array.prototype.slice.call(z);return y.sort()};f=function(y){if(TAFFY.isArray(y)||TAFFY.isObject(y)){return y}else{return JSON.parse(y)}};j=function(z,y){return m(z,function(A){return y.indexOf(A)>=0})};m=function(B,A,z){var y=[];if(B==null){return y}if(Array.prototype.filter&&B.filter===Array.prototype.filter){return B.filter(A,z)}c(B,function(E,C,D){if(A.call(z,E,C,D)){y[y.length]=E}});return y};l=function(y){return Object.prototype.toString.call(y)==="[object RegExp]"};t=function(A){var y=T.isArray(A)?[]:T.isObject(A)?{}:null;if(A===null){return A}for(var z in A){y[z]=l(A[z])?A[z].toString():T.isArray(A[z])||T.isObject(A[z])?t(A[z]):A[z]}return y};a=function(z){var y=JSON.stringify(z);if(y.match(/regex/)===null){return y}return JSON.stringify(t(z))};c=function(B,A,C){var E,D,z,F;if(B&&((T.isArray(B)&&B.length===1)||(!T.isArray(B)))){A((T.isArray(B))?B[0]:B,0)}else{for(E,D,z=0,B=(T.isArray(B))?B:[B],F=B.length;z<F;z++){D=B[z];if(!T.isUndefined(D)||(C||false)){E=A(D,z);if(E===T.EXIT){break}}}}};v=function(C,z){var y=0,B,A;for(A in C){if(C.hasOwnProperty(A)){B=z(C[A],A,y++);if(B===T.EXIT){break}}}};s.extend=function(y,z){s[y]=function(){return z.apply(this,d(arguments))}};x=function(z){var y;if(T.isString(z)&&/[t][0-9]*[r][0-9]*/i.test(z)){return true}if(T.isObject(z)&&z.___id&&z.___s){return true}if(T.isArray(z)){y=true;c(z,function(A){if(!x(A)){y=false;return TAFFY.EXIT}});return y}return false};i=function(A,z){var y=true;c(z,function(B){switch(T.typeOf(B)){case"function":if(!B.apply(A)){y=false;return TAFFY.EXIT}break;case"array":y=(B.length===1)?(i(A,B[0])):(B.length===2)?(i(A,B[0])||i(A,B[1])):(B.length===3)?(i(A,B[0])||i(A,B[1])||i(A,B[2])):(B.length===4)?(i(A,B[0])||i(A,B[1])||i(A,B[2])||i(A,B[3])):false;if(B.length>4){c(B,function(C){if(i(A,C)){y=true}})}break}});return y};w=function(z){var y=[];if(T.isString(z)&&/[t][0-9]*[r][0-9]*/i.test(z)){z={___id:z}}if(T.isArray(z)){c(z,function(A){y.push(w(A))});z=function(){var B=this,A=false;c(y,function(C){if(i(B,C)){A=true}});return A};return z}if(T.isObject(z)){if(T.isObject(z)&&z.___id&&z.___s){z={___id:z.___id}}v(z,function(A,B){if(!T.isObject(A)){A={is:A}}v(A,function(C,D){var F=[],E;E=(D==="hasAll")?function(G,H){H(G)}:c;E(C,function(H){var G=true,I=false,J;J=function(){var O=this[B],N="==",P="!=",R="===",S="<",M=">",U="<=",Q=">=",L="!==",K;if(typeof O==="undefined"){return false}if((D.indexOf("!")===0)&&D!==P&&D!==L){G=false;D=D.substring(1,D.length)}K=((D==="regex")?(H.test(O)):(D==="lt"||D===S)?(O<H):(D==="gt"||D===M)?(O>H):(D==="lte"||D===U)?(O<=H):(D==="gte"||D===Q)?(O>=H):(D==="left")?(O.indexOf(H)===0):(D==="leftnocase")?(O.toLowerCase().indexOf(H.toLowerCase())===0):(D==="right")?(O.substring((O.length-H.length))===H):(D==="rightnocase")?(O.toLowerCase().substring((O.length-H.length))===H.toLowerCase()):(D==="like")?(O.indexOf(H)>=0):(D==="likenocase")?(O.toLowerCase().indexOf(H.toLowerCase())>=0):(D===R||D==="is")?(O===H):(D===N)?(O==H):(D===L)?(O!==H):(D===P)?(O!=H):(D==="isnocase")?(O.toLowerCase?O.toLowerCase()===H.toLowerCase():O===H):(D==="has")?(T.has(O,H)):(D==="hasall")?(T.hasAll(O,H)):(D==="contains")?(TAFFY.isArray(O)&&O.indexOf(H)>-1):(D.indexOf("is")===-1&&!TAFFY.isNull(O)&&!TAFFY.isUndefined(O)&&!TAFFY.isObject(H)&&!TAFFY.isArray(H))?(H===O[D]):(T[D]&&T.isFunction(T[D])&&D.indexOf("is")===0)?T[D](O)===H:(T[D]&&T.isFunction(T[D]))?T[D](O,H):(false));K=(K&&!G)?false:(!K&&!G)?true:K;return K};F.push(J)});if(F.length===1){y.push(F[0])}else{y.push(function(){var H=this,G=false;c(F,function(I){if(I.apply(H)){G=true}});return G})}})});z=function(){var B=this,A=true;A=(y.length===1&&!y[0].apply(B))?false:(y.length===2&&(!y[0].apply(B)||!y[1].apply(B)))?false:(y.length===3&&(!y[0].apply(B)||!y[1].apply(B)||!y[2].apply(B)))?false:(y.length===4&&(!y[0].apply(B)||!y[1].apply(B)||!y[2].apply(B)||!y[3].apply(B)))?false:true;if(y.length>4){c(y,function(C){if(!i(B,C)){A=false}})}return A};return z}if(T.isFunction(z)){return z}};k=function(y,z){var A=function(C,B){var D=0;T.each(z,function(G){var I,F,E,J,H;I=G.split(" ");F=I[0];E=(I.length===1)?"logical":I[1];if(E==="logical"){J=h(C[F]);H=h(B[F]);T.each((J.length<=H.length)?J:H,function(K,L){if(J[L]<H[L]){D=-1;return TAFFY.EXIT}else{if(J[L]>H[L]){D=1;return TAFFY.EXIT}}})}else{if(E==="logicaldesc"){J=h(C[F]);H=h(B[F]);T.each((J.length<=H.length)?J:H,function(K,L){if(J[L]>H[L]){D=-1;return TAFFY.EXIT}else{if(J[L]<H[L]){D=1;return TAFFY.EXIT}}})}else{if(E==="asec"&&C[F]<B[F]){D=-1;return T.EXIT}else{if(E==="asec"&&C[F]>B[F]){D=1;return T.EXIT}else{if(E==="desc"&&C[F]>B[F]){D=-1;return T.EXIT}else{if(E==="desc"&&C[F]<B[F]){D=1;return T.EXIT}}}}}}if(D===0&&E==="logical"&&J.length<H.length){D=-1}else{if(D===0&&E==="logical"&&J.length>H.length){D=1}else{if(D===0&&E==="logicaldesc"&&J.length>H.length){D=-1}else{if(D===0&&E==="logicaldesc"&&J.length<H.length){D=1}}}}if(D!==0){return T.EXIT}});return D};return(y&&y.push)?y.sort(A):y};(function(){var y={},z=0;h=function(A){if(z>n){y={};z=0}return y["_"+A]||(function(){var E=String(A),D=[],H="_",C="",B,F,G;for(B=0,F=E.length;B<F;B++){G=E.charCodeAt(B);if((G>=48&&G<=57)||G===46){if(C!=="n"){C="n";D.push(H.toLowerCase());H=""}H=H+E.charAt(B)}else{if(C!=="s"){C="s";D.push(parseFloat(H));H=""}H=H+E.charAt(B)}}D.push((C==="n")?parseFloat(H):H.toLowerCase());D.shift();y["_"+A]=D;z++;return D}())}}());p=function(){this.context({results:this.getDBI().query(this.context())})};s.extend("filter",function(){var z=TAFFY.mergeObj(this.context(),{run:null}),y=[];c(z.q,function(A){y.push(A)});z.q=y;c(d(arguments),function(A){z.q.push(w(A));z.filterRaw.push(A)});return this.getroot(z)});s.extend("order",function(z){z=z.split(",");var y=[],A;c(z,function(B){y.push(B.replace(/^\s*/,"").replace(/\s*$/,""))});A=TAFFY.mergeObj(this.context(),{sort:null});A.order=y;return this.getroot(A)});s.extend("limit",function(A){var z=TAFFY.mergeObj(this.context(),{}),y;z.limit=A;if(z.run&&z.sort){y=[];c(z.results,function(C,B){if((B+1)>A){return TAFFY.EXIT}y.push(C)});z.results=y}return this.getroot(z)});s.extend("start",function(A){var z=TAFFY.mergeObj(this.context(),{}),y;z.start=A;if(z.run&&z.sort&&!z.limit){y=[];c(z.results,function(C,B){if((B+1)>A){y.push(C)}});z.results=y}else{z=TAFFY.mergeObj(this.context(),{run:null,start:A})}return this.getroot(z)});s.extend("update",function(B,A,y){var C=true,E={},z=d(arguments),D;if(TAFFY.isString(B)&&(arguments.length===2||arguments.length===3)){E[B]=A;if(arguments.length===3){C=y}}else{E=B;if(z.length===2){C=A}}D=this;p.call(this);c(this.context().results,function(F){var G=E;if(TAFFY.isFunction(G)){G=G.apply(TAFFY.mergeObj(F,{}))}else{if(T.isFunction(G)){G=G(TAFFY.mergeObj(F,{}))}}if(TAFFY.isObject(G)){D.getDBI().update(F.___id,G,C)}});if(this.context().results.length){this.context({run:null})}return this});s.extend("remove",function(y){var z=this,A=0;p.call(this);c(this.context().results,function(B){z.getDBI().remove(B.___id);A++});if(this.context().results.length){this.context({run:null});z.getDBI().removeCommit(y)}return A});s.extend("count",function(){p.call(this);return this.context().results.length});s.extend("callback",function(A,y){if(A){var z=this;setTimeout(function(){p.call(z);A.call(z.getroot(z.context()))},y||0)}return null});s.extend("get",function(){p.call(this);return this.context().results});s.extend("stringify",function(){return JSON.stringify(this.get())});s.extend("first",function(){p.call(this);return this.context().results[0]||false});s.extend("last",function(){p.call(this);return this.context().results[this.context().results.length-1]||false});s.extend("sum",function(){var z=0,y=this;p.call(y);c(d(arguments),function(A){c(y.context().results,function(B){z=z+(B[A]||0)})});return z});s.extend("min",function(z){var y=null;p.call(this);c(this.context().results,function(A){if(y===null||A[z]<y){y=A[z]}});return y});(function(){var y=(function(){var B,z,A;B=function(F,H,E){var D,G,I,C;if(E.length===2){D=F[E[0]];I="===";G=H[E[1]]}else{D=F[E[0]];I=E[1];G=H[E[2]]}switch(I){case"===":return D===G;case"!==":return D!==G;case"<":return D<G;case">":return D>G;case"<=":return D<=G;case">=":return D>=G;case"==":return D==G;case"!=":return D!=G;default:throw String(I)+" is not supported"}};z=function(D,G){var C={},E,F;for(E in D){if(D.hasOwnProperty(E)){C[E]=D[E]}}for(E in G){if(G.hasOwnProperty(E)&&E!=="___id"&&E!=="___s"){F=!TAFFY.isUndefined(C[E])?"right_":"";C[F+String(E)]=G[E]}}return C};A=function(G){var C,E,D=d(arguments),F=D.length,H=[];if(typeof G.filter!=="function"){if(G.TAFFY){C=G()}else{throw"TAFFY DB or result not supplied"}}else{C=G}this.context({results:this.getDBI().query(this.context())});TAFFY.each(this.context().results,function(I){C.each(function(L){var J,K=true;CONDITION:for(E=1;E<F;E++){J=D[E];if(typeof J==="function"){K=J(I,L)}else{if(typeof J==="object"&&J.length){K=B(I,L,J)}else{K=false}}if(!K){break CONDITION}}if(K){H.push(z(I,L))}})});return TAFFY(H)()};return A}());s.extend("join",y)}());s.extend("max",function(z){var y=null;p.call(this);c(this.context().results,function(A){if(y===null||A[z]>y){y=A[z]}});return y});s.extend("select",function(){var z=[],y=d(arguments);p.call(this);if(arguments.length===1){c(this.context().results,function(A){z.push(A[y[0]])})}else{c(this.context().results,function(A){var B=[];c(y,function(C){B.push(A[C])});z.push(B)})}return z});s.extend("distinct",function(){var z=[],y=d(arguments);p.call(this);if(arguments.length===1){c(this.context().results,function(B){var A=B[y[0]],C=false;c(z,function(D){if(A===D){C=true;return TAFFY.EXIT}});if(!C){z.push(A)}})}else{c(this.context().results,function(A){var C=[],B=false;c(y,function(D){C.push(A[D])});c(z,function(E){var D=true;c(y,function(G,F){if(C[F]!==E[F]){D=false;return TAFFY.EXIT}});if(D){B=true;return TAFFY.EXIT}});if(!B){z.push(C)}})}return z});s.extend("supplant",function(z,y){var A=[];p.call(this);c(this.context().results,function(B){A.push(z.replace(/\{([^\{\}]*)\}/g,function(D,C){var E=B[C];return typeof E==="string"||typeof E==="number"?E:D}))});return(!y)?A.join(""):A});s.extend("each",function(y){p.call(this);c(this.context().results,y);return this});s.extend("map",function(y){var z=[];p.call(this);c(this.context().results,function(A){z.push(y(A))});return z});T=function(G){var D=[],H={},E=1,A={template:false,onInsert:false,onUpdate:false,onRemove:false,onDBChange:false,storageName:false,forcePropertyCase:null,cacheSize:100,name:""},C=new Date(),B=0,z=0,J={},F,y,I;y=function(M){var L=[],K=false;if(M.length===0){return D}c(M,function(N){if(T.isString(N)&&/[t][0-9]*[r][0-9]*/i.test(N)&&D[H[N]]){L.push(D[H[N]]);K=true}if(T.isObject(N)&&N.___id&&N.___s&&D[H[N.___id]]){L.push(D[H[N.___id]]);K=true}if(T.isArray(N)){c(N,function(O){c(y(O),function(P){L.push(P)})})}});if(K&&L.length>1){L=[]}return L};F={dm:function(K){if(K){C=K;J={};B=0;z=0}if(A.onDBChange){setTimeout(function(){A.onDBChange.call(D)},0)}if(A.storageName){setTimeout(function(){localStorage.setItem("taffy_"+A.storageName,JSON.stringify(D))})}return C},insert:function(N,O){var M=[],L=[],K=f(N);c(K,function(Q,R){var P,S;if(T.isArray(Q)&&R===0){c(Q,function(U){M.push((A.forcePropertyCase==="lower")?U.toLowerCase():(A.forcePropertyCase==="upper")?U.toUpperCase():U)});return true}else{if(T.isArray(Q)){P={};c(Q,function(V,U){P[M[U]]=V});Q=P}else{if(T.isObject(Q)&&A.forcePropertyCase){S={};v(Q,function(V,U){S[(A.forcePropertyCase==="lower")?U.toLowerCase():(A.forcePropertyCase==="upper")?U.toUpperCase():U]=Q[U]});Q=S}}}E++;Q.___id="T"+String(o+b).slice(-6)+"R"+String(o+E).slice(-6);Q.___s=true;L.push(Q.___id);if(A.template){Q=T.mergeObj(A.template,Q)}D.push(Q);H[Q.___id]=D.length-1;if(A.onInsert&&(O||TAFFY.isUndefined(O))){A.onInsert.call(Q)}F.dm(new Date())});return I(L)},sort:function(K){D=k(D,K.split(","));H={};c(D,function(M,L){H[M.___id]=L});F.dm(new Date());return true},update:function(R,N,M){var Q={},P,O,K,L;if(A.forcePropertyCase){v(N,function(S,U){Q[(A.forcePropertyCase==="lower")?U.toLowerCase():(A.forcePropertyCase==="upper")?U.toUpperCase():U]=S});N=Q}P=D[H[R]];O=T.mergeObj(P,N);K={};L=false;v(O,function(S,U){if(TAFFY.isUndefined(P[U])||P[U]!==S){K[U]=S;L=true}});if(L){if(A.onUpdate&&(M||TAFFY.isUndefined(M))){A.onUpdate.call(O,D[H[R]],K)}D[H[R]]=O;F.dm(new Date())}},remove:function(K){D[H[K]].___s=false},removeCommit:function(L){var K;for(K=D.length-1;K>-1;K--){if(!D[K].___s){if(A.onRemove&&(L||TAFFY.isUndefined(L))){A.onRemove.call(D[K])}H[D[K].___id]=undefined;D.splice(K,1)}}H={};c(D,function(N,M){H[N.___id]=M});F.dm(new Date())},query:function(M){var P,Q,L,O,N,K;if(A.cacheSize){Q="";c(M.filterRaw,function(R){if(T.isFunction(R)){Q="nocache";return TAFFY.EXIT}});if(Q===""){Q=a(T.mergeObj(M,{q:false,run:false,sort:false}))}}if(!M.results||!M.run||(M.run&&F.dm()>M.run)){L=[];if(A.cacheSize&&J[Q]){J[Q].i=B++;return J[Q].results}else{if(M.q.length===0&&M.index.length===0){c(D,function(R){L.push(R)});P=L}else{O=y(M.index);c(O,function(R){if(M.q.length===0||i(R,M.q)){L.push(R)}});P=L}}}else{P=M.results}if(M.order.length>0&&(!M.run||!M.sort)){P=k(P,M.order)}if(P.length&&((M.limit&&M.limit<P.length)||M.start)){N=[];c(P,function(S,R){if(!M.start||(M.start&&(R+1)>=M.start)){if(M.limit){K=(M.start)?(R+1)-M.start:R;if(K<M.limit){N.push(S)}else{if(K>M.limit){return TAFFY.EXIT}}}else{N.push(S)}}});P=N}if(A.cacheSize&&Q!=="nocache"){z++;setTimeout(function(){var R,S;if(z>=A.cacheSize*2){z=0;R=B-A.cacheSize;S={};v(function(V,U){if(V.i>=R){S[U]=V}});J=S}},0);J[Q]={i:B++,results:P}}return P}};I=function(){var L,K;L=TAFFY.mergeObj(TAFFY.mergeObj(s,{insert:undefined}),{getDBI:function(){return F},getroot:function(M){return I.call(M)},context:function(M){if(M){K=TAFFY.mergeObj(K,M.hasOwnProperty("results")?TAFFY.mergeObj(M,{run:new Date(),sort:new Date()}):M)}return K},extend:undefined});K=(this&&this.q)?this:{limit:false,start:false,q:[],filterRaw:[],index:[],order:[],results:false,run:null,sort:null,settings:A};c(d(arguments),function(M){if(x(M)){K.index.push(M)}else{K.q.push(w(M))}K.filterRaw.push(M)});return L};b++;if(G){F.insert(G)}I.insert=F.insert;I.merge=function(N,M,O){var L={},K=[],P={};O=O||false;M=M||"id";c(N,function(R){var Q;L[M]=R[M];K.push(R[M]);Q=I(L).first();if(Q){F.update(Q.___id,R,O)}else{F.insert(R,O)}});P[M]=K;return I(P)};I.TAFFY=true;I.sort=F.sort;I.settings=function(K){if(K){A=TAFFY.mergeObj(A,K);if(K.template){I().update(K.template)}}return A};I.store=function(M){var L=false,K;if(localStorage){if(M){K=localStorage.getItem("taffy_"+M);if(K&&K.length>0){I.insert(K);L=true}if(D.length>0){setTimeout(function(){localStorage.setItem("taffy_"+A.storageName,JSON.stringify(D))})}}I.settings({storageName:M})}return I};return I};TAFFY=T;T.each=c;T.eachin=v;T.extend=s.extend;TAFFY.EXIT="TAFFYEXIT";TAFFY.mergeObj=function(A,y){var z={};v(A,function(B,C){z[C]=A[C]});v(y,function(B,C){z[C]=y[C]});return z};TAFFY.has=function(A,z){var y=false,B;if((A.TAFFY)){y=A(z);if(y.length>0){return true}else{return false}}else{switch(T.typeOf(A)){case"object":if(T.isObject(z)){v(z,function(C,D){if(y===true&&!T.isUndefined(A[D])&&A.hasOwnProperty(D)){y=T.has(A[D],z[D])}else{y=false;return TAFFY.EXIT}})}else{if(T.isArray(z)){c(z,function(C,D){y=T.has(A,z[D]);if(y){return TAFFY.EXIT}})}else{if(T.isString(z)){if(!TAFFY.isUndefined(A[z])){return true}else{return false}}}}return y;case"array":if(T.isObject(z)){c(A,function(C,D){y=T.has(A[D],z);if(y===true){return TAFFY.EXIT}})}else{if(T.isArray(z)){c(z,function(D,C){c(A,function(F,E){y=T.has(A[E],z[C]);if(y===true){return TAFFY.EXIT}});if(y===true){return TAFFY.EXIT}})}else{if(T.isString(z)||T.isNumber(z)){y=false;for(B=0;B<A.length;B++){y=T.has(A[B],z);if(y){return true}}}}}return y;case"string":if(T.isString(z)&&z===A){return true}break;default:if(T.typeOf(A)===T.typeOf(z)&&A===z){return true}break}}return false};TAFFY.hasAll=function(B,A){var z=TAFFY,y;if(z.isArray(A)){y=true;c(A,function(C){y=z.has(B,C);if(y===false){return TAFFY.EXIT}});return y}else{return z.has(B,A)}};TAFFY.typeOf=function(y){var z=typeof y;if(z==="object"){if(y){if(typeof y.length==="number"&&!(y.propertyIsEnumerable("length"))){z="array"}}else{z="null"}}return z};TAFFY.getObjectKeys=function(y){var z=[];v(y,function(B,A){z.push(A)});z.sort();return z};TAFFY.isSameArray=function(z,y){return(TAFFY.isArray(z)&&TAFFY.isArray(y)&&z.join(",")===y.join(","))?true:false};TAFFY.isSameObject=function(B,z){var y=TAFFY,A=true;if(y.isObject(B)&&y.isObject(z)){if(y.isSameArray(y.getObjectKeys(B),y.getObjectKeys(z))){v(B,function(C,D){if(!((y.isObject(B[D])&&y.isObject(z[D])&&y.isSameObject(B[D],z[D]))||(y.isArray(B[D])&&y.isArray(z[D])&&y.isSameArray(B[D],z[D]))||(B[D]===z[D]))){A=false;return TAFFY.EXIT}})}else{A=false}}else{A=false}return A};g=["String","Number","Object","Array","Boolean","Null","Function","Undefined"];r=function(y){return function(z){return TAFFY.typeOf(z)===y.toLowerCase()?true:false}};for(q=0;q<g.length;q++){u=g[q];TAFFY["is"+u]=r(u)}}}());if(typeof(exports)==="object"){exports.taffy=TAFFY};